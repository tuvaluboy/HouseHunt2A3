using HouseHunt2.Models;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net;
using System.Net.Mail;
using System.Web;

namespace HouseHunt2.Controllers
{
    public class Emailcs
    {
        public void send(string sender, string password, string receiver, string subject, string body)
        {
            string emailSender = sender;
            string emailSenderPassword = password; //cs415assignment
            string emailReceiver = receiver;
            string emailSubject = subject;
            string msgBody = body;

            int aDay = 24;


            //******************************************************
            // DB Stuff get the appointment related table TODO
            HouseHountEntities db = new HouseHountEntities();
            var item = from d in db.PropertyAgents
                       select d;

            // *********************************************

            using (var message = new MailMessage(emailSender, emailReceiver))
            {
                foreach (var items in item)
                {

                    // compare current time with appointment time 
                    DateTime inspectionTime = (DateTime)items.AvailableDate;
                    TimeSpan timeGap = inspectionTime.Subtract(DateTime.Now);

                    // ****************************************

                    string note = "Dear Sir \n" +
                        " Please be a advised that you have a house inspection at: " + inspectionTime.ToString();

                    msgBody = note + inspectionTime.ToString();

                    if (timeGap.Hours <= aDay) // if less than or equal to 24 hours and email sent is no
                    {
                        message.Subject = emailSubject;
                        using (SmtpClient client = new SmtpClient
                        {
                            EnableSsl = true,
                            Host = "smtp.gmail.com",
                            Port = 587,
                            Credentials = new NetworkCredential(emailSender, emailSenderPassword)
                        })
                        {
                            client.Send(message);
                        }

                    }


                }
            }
        }

        
    }
}